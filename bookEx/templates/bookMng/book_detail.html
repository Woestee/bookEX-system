{% extends "base.html" %}
{% load static %}

{% block sidenav %}
   {% for item in item_list %}
      <li>
        <a href="{{ item.link }}">  {{ item.item }} </a>
      </li>
   {% endfor %}
{% endblock sidenav %}

{% block content %}
<h1>Book Detail</h1>

<table border="2" width="100%">
   <tr>
      <th>Book Picture</th>
      <th>Book Name</th>
      <th>Book Price</th>
      <th>User Name</th>
      <th>Book Post Date</th>
      <th>Book Web</th>
      <th>Average Rating</th>
      <th>User Ratings</th>
      <th>User Comments</th>
   </tr>

   <tr valign="top">
      <td><img src="{% static book.pic_path %}" width="100" /></td>
      <td>{{ book.name }}</td>
      <td>{{ book.price }}</td>
      <td>{{ book.username }}</td>
      <td>{{ book.publishdate }}</td>
      <td><a href="{{ book.web }}" target="_blank">{{ book.web }}</a></td>

      <!-- Average Rating -->
      <td>
         {% if avg_rating %}
            {{ avg_rating|floatformat:1 }} / 5
         {% else %}
            No ratings yet
         {% endif %}
      </td>

      <!-- User Ratings -->
      <td>
           {% if ratings %}
              <ul style="margin:0; padding-left:15px;">
                 {% for r in ratings %}
                    <li>
                        <strong>{{ r.user.username }}</strong>: {{ r.value }}/5

                        {% if user.is_authenticated and user == r.user %}
                            <br>
                            <a href="{% url 'delete_rating' r.id %}"
                               onclick="return confirm('Delete this rating?');"
                               style="color:red; font-size:0.9em;">
                               Delete
                            </a>
                        {% endif %}
                    </li>
                 {% endfor %}
              </ul>
           {% else %}
              <em>No ratings yet</em>
           {% endif %}
      </td>

      <!-- User Comments -->
      <td>
           {% if comments %}
              <ul style="margin:0; padding-left:15px;">
                 {% for c in comments %}
                    <li>
                        <strong>{{ c.user.username }}</strong>
                        ({{ c.created_at|date:"M d, Y H:i" }}):<br>
                        {{ c.text }}

                        {% if user.is_authenticated and user == c.user %}
                            <br>
                            <a href="{% url 'delete_comment' c.id %}"
                               onclick="return confirm('Delete this comment?');"
                               style="color:red; font-size:0.9em;">
                               Delete
                            </a>
                        {% endif %}
                    </li>
                 {% endfor %}
              </ul>
           {% else %}
              <em>No comments yet</em>
           {% endif %}
      </td>
    <tr>
        <td colspan="9" style="text-align:center; padding: 15px;">

            {% if user.is_authenticated %}

                <a href="{% url 'add_comment' book.id %}"
                   style="background:#2b78e4; color:white; padding:8px 15px;
                          margin-right:10px; border-radius:5px; text-decoration:none;">
                   ➕ Add Comment
                </a>

                <a href="{% url 'add_rating' book.id %}"
                   style="background:#34a853; color:white; padding:8px 15px;
                          border-radius:5px; text-decoration:none;">
                   ⭐ Add Rating
                </a>

            {% else %}

                <p style="color:red; font-weight:bold;">
                    Please
                    <a href="/login/?next={% url 'book_detail' book.id %}">
                        log in
                    </a>
                    to add comments or ratings.
                </p>

            {% endif %}

        </td>
    </tr>
</table>

{% endblock content %}
